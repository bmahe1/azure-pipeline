trigger:
  branches:
    include:
      - main

variables:
  storageAccountName: 'ichmahesh123'
  containerName: 'mahesh'
  azureSubscription: 'azure-myfrontend-connection'

stages:
# ------------------ BUILD ------------------
- stage: Build
  displayName: "Build Stage"
  jobs:
  - job: build
    displayName: "Build static files"
    pool:
      name: 'my-agent-0vm'       # <---- self-hosted agent
    steps:
    - checkout: self

    - script: chmod +x ./scripts/build.sh
      displayName: "Make build.sh executable"

    - script: ./scripts/build.sh
      displayName: "Build artifact (zip www)"

    - task: PublishPipelineArtifact@1
      displayName: "Publish site.zip"
      inputs:
        targetPath: site.zip
        artifact: site

# ------------------ DEPLOY ------------------
- stage: Deploy
  dependsOn: Build
  displayName: "Deploy Stage"
  jobs:
  - job: deploy
    displayName: "Deploy to Azure Blob"
    pool:
      name: 'my-agent-0vm'       # <---- self-hosted agent
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: "Upload to Azure Blob Storage"
      inputs:
        azureSubscription: 'azure-myfrontend-connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Account: $(storageAccountName), Container: $(containerName)"
          
          az storage container create \
            --account-name $(storageAccountName) \
            --name $(containerName) \
            --auth-mode login

          echo "Uploading contents of www/ to $(containerName)..."
          az storage blob upload-batch \
            --account-name $(storageAccountName) \
            --destination $(containerName) \
            --source www \
            --auth-mode login

          echo "âœ… Upload complete!"
